#!/usr/bin/env node

// Ralph Dev Loop Project Initializer (Cross-platform Node.js ESM)
// Creates project scaffolding for long-running development sessions.
// Pure Node.js - no external dependencies.

import { writeFileSync, mkdirSync, existsSync, readFileSync } from 'fs';
import { join, resolve, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const projectDir = process.argv[2] || process.cwd();
const resolvedDir = resolve(projectDir);

// Create progress file
const progressPath = join(resolvedDir, 'claude-progress.txt');
if (!existsSync(progressPath)) {
  const progressContent = `# Claude Progress Log
# Generated by ralph-dev-loop initializer
# Updated at the end of each development session

## Project Status
- Status: NOT STARTED
- Features completed: 0 / 0
- Last updated: ${new Date().toISOString()}

## Session History
(No sessions yet)
`;
  writeFileSync(progressPath, progressContent, 'utf-8');
  console.log(`\u2705 Created: ${progressPath}`);
} else {
  console.log(`\u23ed\ufe0f  Skipped: ${progressPath} (already exists)`);
}

// Create feature list from template
const featureListPath = join(resolvedDir, 'feature_list.json');
if (!existsSync(featureListPath)) {
  // Try to read template from assets
  const templatePath = join(__dirname, '..', 'assets', 'feature_list_template.json');
  let template;
  if (existsSync(templatePath)) {
    template = JSON.parse(readFileSync(templatePath, 'utf-8'));
  } else {
    template = {
      project: 'PROJECT_NAME',
      generated_at: 'TIMESTAMP',
      features: [
        {
          id: 1,
          category: 'infrastructure',
          description: 'REPLACE: describe the feature',
          steps: ['REPLACE: verification step 1'],
          passes: false,
        },
      ],
    };
  }

  // Fill in timestamps
  template.generated_at = new Date().toISOString();

  writeFileSync(featureListPath, JSON.stringify(template, null, 2) + '\n', 'utf-8');
  console.log(`\u2705 Created: ${featureListPath}`);
} else {
  console.log(`\u23ed\ufe0f  Skipped: ${featureListPath} (already exists)`);
}

// Create init.sh for macOS/Linux
const initShPath = join(resolvedDir, 'init.sh');
if (!existsSync(initShPath)) {
  writeFileSync(initShPath, `#!/bin/bash
# Development environment startup script
# Generated by ralph-dev-loop initializer
# Customize this for your project's needs

set -euo pipefail

echo "Starting development environment..."

# TODO: Add your project's setup commands here
# Examples:
#   npm install && npm run dev &
#   python -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt
#   docker-compose up -d

echo "Development environment ready."
`, 'utf-8');
  console.log(`\u2705 Created: ${initShPath}`);
} else {
  console.log(`\u23ed\ufe0f  Skipped: ${initShPath} (already exists)`);
}

// Create init.cmd for Windows
const initCmdPath = join(resolvedDir, 'init.cmd');
if (!existsSync(initCmdPath)) {
  writeFileSync(initCmdPath, `@echo off
REM Development environment startup script
REM Generated by ralph-dev-loop initializer
REM Customize this for your project's needs

echo Starting development environment...

REM TODO: Add your project's setup commands here
REM Examples:
REM   npm install && npm run dev
REM   python -m venv .venv && .venv\\Scripts\\activate && pip install -r requirements.txt
REM   docker-compose up -d

echo Development environment ready.
`, 'utf-8');
  console.log(`\u2705 Created: ${initCmdPath}`);
} else {
  console.log(`\u23ed\ufe0f  Skipped: ${initCmdPath} (already exists)`);
}

// Summary
console.log(`
\ud83d\udce6 Project scaffolding complete!

Next steps:
  1. Edit feature_list.json to define your project's features
  2. Customize init.sh (or init.cmd on Windows) for your dev environment
  3. Start the loop:
     /ralph-dev-loop "Build [PROJECT] following feature_list.json" \\
       --completion-promise "ALL FEATURES COMPLETE" \\
       --max-iterations 30

Files created in: ${resolvedDir}
`);
